# Архитектура проекта

## Обзор

Holiday Traditions Bot построен по модульному принципу, где каждый компонент отвечает за свою область.

## Структура файлов

```
holiday_bot/
│
├── bot.py              # Telegram bot логика и команды
├── llm.py              # OpenAI API интеграция
├── countries.py        # Данные: страны и праздники
├── config.py           # Конфигурация и константы
├── requirements.txt    # Python зависимости
├── .env.example        # Шаблон переменных окружения
├── .gitignore          # Git ignore правила
├── README.md           # Основная документация
├── QUICKSTART.md       # Быстрый старт
└── ARCHITECTURE.md     # Этот файл
```

## Компоненты

### 1. bot.py

**Назначение**: Основная логика Telegram бота

**Ключевые функции**:
- `start_command()` — приветствие пользователя
- `holiday_command()` — генерация случайной традиции
- `christmas_command()` — традиции Рождества
- `newyear_command()` — традиции Нового года
- `another_command()` — повтор с новой страной
- `send_holiday_info()` — генерация и отправка информации
- `button_callback()` — обработка inline-кнопок
- `error_handler()` — обработка ошибок

**Зависимости**:
- `python-telegram-bot` для работы с Telegram API
- `config.py` для токена бота
- `countries.py` для списка стран
- `llm.py` для генерации контента

**Поток работы**:
```
Пользователь → Команда → Выбор страны → LLM генерация → Форматирование → Отправка
```

### 2. llm.py

**Назначение**: Интеграция с OpenAI API для генерации контента

**Ключевые функции**:
- `generate_holiday_tradition()` — основная функция генерации
- `test_llm_connection()` — проверка подключения

**Параметры генерации**:
- `model`: gpt-4o-mini (по умолчанию)
- `max_tokens`: 1000
- `temperature`: 0.8 (для креативности)

**Формат запроса**:
```python
{
  "messages": [
    {"role": "system", "content": SYSTEM_PROMPT},
    {"role": "user", "content": user_prompt}
  ]
}
```

### 3. config.py

**Назначение**: Централизованная конфигурация

**Содержимое**:
- Загрузка переменных окружения
- Проверка наличия обязательных токенов
- Системный промпт для LLM
- Константы настроек

**Безопасность**:
- Использует `python-dotenv` для изоляции секретов
- Проверяет наличие обязательных переменных при запуске

### 4. countries.py

**Назначение**: Данные о странах и праздниках

**Структура**:
```python
COUNTRIES = [...]  # Список из 50+ стран
HOLIDAY_TYPES = {
    "christmas": "Рождество",
    "newyear": "Новый год"
}
```

**Расширение**: Просто добавьте новые страны в список

### 5. requirements.txt

**Зависимости**:
- `python-telegram-bot==21.0.1` — Telegram Bot API
- `openai==1.58.1` — OpenAI API клиент
- `python-dotenv==1.0.0` — Управление .env файлами

## Взаимодействие компонентов

```
┌─────────────┐
│   User      │
│ (Telegram)  │
└──────┬──────┘
       │
       │ /holiday
       ▼
┌─────────────────┐
│    bot.py       │
│                 │
│ - Получает      │
│   команду       │
│ - Выбирает      │
│   страну        │
└────┬────────────┘
     │
     │ generate_holiday_tradition()
     ▼
┌─────────────────┐       ┌──────────────┐
│    llm.py       │◄──────┤  config.py   │
│                 │       │              │
│ - Формирует     │       │ - Токены     │
│   промпт        │       │ - Настройки  │
│ - Вызывает API  │       └──────────────┘
└────┬────────────┘
     │              ┌──────────────┐
     │◄─────────────┤countries.py  │
     │              │              │
     │              │ - Страны     │
     ▼              └──────────────┘
┌─────────────────┐
│  OpenAI API     │
│                 │
│ - Генерирует    │
│   текст         │
└────┬────────────┘
     │
     │ Результат
     ▼
┌─────────────────┐
│    bot.py       │
│                 │
│ - Форматирует   │
│ - Добавляет     │
│   кнопки        │
│ - Отправляет    │
└────┬────────────┘
     │
     ▼
┌─────────────┐
│   User      │
│ (Telegram)  │
└─────────────┘
```

## Обработка ошибок

### Уровень 1: Валидация конфигурации
- Проверка наличия токенов при импорте `config.py`
- Падение с понятным сообщением, если токены отсутствуют

### Уровень 2: API ошибки
- `try/except` блоки в `llm.py`
- Возврат читаемого сообщения об ошибке

### Уровень 3: Bot ошибки
- `error_handler()` в `bot.py`
- Логирование ошибок
- Отправка пользователю дружественного сообщения

## Состояние пользователя

Используется `context.user_data` для хранения:
- `last_country` — последняя выбранная страна
- `last_holiday` — последний тип праздника

Это позволяет команде `/another` повторить генерацию для того же типа праздника.

## Inline-кнопки

Реализованы через `InlineKeyboardMarkup`:
```python
keyboard = [[
    InlineKeyboardButton("Другая страна", callback_data="another")
]]
```

Обработчик `button_callback()` получает `callback_data` и выполняет соответствующее действие.

## Безопасность

1. **Секреты не в коде**: все токены в `.env`
2. **Git ignore**: `.env` в `.gitignore`
3. **Валидация входных данных**: нет прямого пользовательского ввода в промпты
4. **Лимиты токенов**: `max_tokens=1000` предотвращает избыточные траты

## Производительность

- **Асинхронность**: использование `async/await` в bot.py
- **Кэширование**: нет (каждый запрос — новая генерация)
- **Rate limiting**: полагается на лимиты OpenAI и Telegram

## Расширяемость

### Добавление новой команды

1. Создайте функцию в `bot.py`:
```python
async def new_command(update, context):
    # ваша логика
    pass
```

2. Зарегистрируйте в `main()`:
```python
application.add_handler(CommandHandler("newcmd", new_command))
```

### Изменение формата вывода

Отредактируйте `SYSTEM_PROMPT` в `config.py`

### Добавление новых стран

Добавьте в список `COUNTRIES` в `countries.py`

### Смена LLM провайдера

Создайте новый модуль (например, `anthropic_llm.py`) с той же сигнатурой функции `generate_holiday_tradition()` и замените импорт в `bot.py`

## Тестирование

### Тест LLM модуля
```bash
python llm.py
```

### Тест бота
```bash
python bot.py
# Затем взаимодействие через Telegram
```

## Мониторинг и логирование

- Используется стандартный `logging` модуль Python
- Уровень: `INFO`
- Логи выводятся в stdout
- Формат: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`

## Будущие улучшения

1. **База данных**: хранение истории запросов
2. **Аналитика**: статистика популярных стран
3. **Кэширование**: Redis для популярных запросов
4. **Изображения**: интеграция DALL-E или Unsplash
5. **Локализация**: поддержка нескольких языков
6. **Webhook**: вместо polling для продакшена
7. **Тесты**: unit и integration тесты
8. **CI/CD**: автоматическое развертывание
9. **Мониторинг**: Prometheus + Grafana
10. **Rate limiting**: собственные лимиты на пользователя
